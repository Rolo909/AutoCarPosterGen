import os
import json
from PIL import Image
from io import BytesIO
from dotenv import load_dotenv
from google import genai
from google.genai import types
from pathlib import Path

load_dotenv()

class CarPosterGenerator:
    
    def __init__(self, reference_image_path=None, output_format=None):
        # ะะฐะณััะทะบะฐ ะฝะฐัััะพะตะบ ะธะท .env
        self.reference_path = reference_image_path or os.getenv('REFERENCE_IMAGE_PATH')
        if not self.reference_path:
            raise ValueError("REFERENCE_IMAGE_PATH ะฝะต ัะบะฐะทะฐะฝ ะฒ .env ัะฐะนะปะต ะธ ะฝะต ะฟะตัะตะดะฐะฝ ะฒ ะฟะฐัะฐะผะตััะฐั!")
        
        self.output_format = (output_format or os.getenv('DEFAULT_OUTPUT_FORMAT', 'png')).lower()
        self.output_directory = os.getenv('OUTPUT_DIRECTORY', 'output')
        
        # API ะบะปัั
        api_key = os.getenv('GEMINI_API_KEY')
        if not api_key:
            raise ValueError("GEMINI_API_KEY ะฝะต ะฝะฐะนะดะตะฝ ะฒ .env ัะฐะนะปะต!")
        
        # ะะฝะธัะธะฐะปะธะทะฐัะธั ะฝะพะฒะพะณะพ SDK
        self.client = genai.Client(api_key=api_key)
        
        # ะัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ัะตัะตัะตะฝัะฝะพะณะพ ะธะทะพะฑัะฐะถะตะฝะธั
        if not os.path.exists(self.reference_path):
            raise ValueError(f"ะะตัะตัะตะฝัะฝะพะต ะธะทะพะฑัะฐะถะตะฝะธะต ะฝะต ะฝะฐะนะดะตะฝะพ: {self.reference_path}")
        
        self.reference_image = Image.open(self.reference_path)
        print(f"โ ะะตัะตัะตะฝัะฝะพะต ะธะทะพะฑัะฐะถะตะฝะธะต ะทะฐะณััะถะตะฝะพ: {self.reference_path}")
        
    def search_car_specifications(self, make, model, year=None, trim=None):
        """ะะพะธัะบ ัะตัะฝะธัะตัะบะธั ัะฐัะฐะบัะตัะธััะธะบ ะฐะฒัะพะผะพะฑะธะปั ัะตัะตะท Gemini"""
        print(f"๐ ะะพะธัะบ ัะฐัะฐะบัะตัะธััะธะบ: {make} {model}...")
        
        query = f"{make} {model}"
        if year:
            query += f" {year}"
        if trim:
            query += f" {trim}"
            
        prompt = f"""
ะขั ะฐะฒัะพะผะพะฑะธะปัะฝัะน ัะบัะฟะตัั. ะะฐะนะดะธ ัะพัะฝัะต ะพัะธัะธะฐะปัะฝัะต ัะตัะฝะธัะตัะบะธะต ัะฐัะฐะบัะตัะธััะธะบะธ ะฐะฒัะพะผะพะฑะธะปั: {query}

ะะตัะฝะธ ะธะฝัะพัะผะฐัะธั ะกะขะะะะ ะฒ JSON ัะพัะผะฐัะต (ะฑะตะท markdown, ะฑะตะท ะดะพะฟะพะปะฝะธัะตะปัะฝะพะณะพ ัะตะบััะฐ):
{{
    "make": "ะะฐัะบะฐ ะฐะฒัะพะผะพะฑะธะปั (ัะพัะฝะพะต ะพัะธัะธะฐะปัะฝะพะต ะฝะฐะทะฒะฐะฝะธะต)",
    "model": "ะะพะดะตะปั (ัะพัะฝะพะต ะพัะธัะธะฐะปัะฝะพะต ะฝะฐะทะฒะฐะฝะธะต)",
    "year_range": "ะะพะด ะธะปะธ ะดะธะฐะฟะฐะทะพะฝ ะณะพะดะพะฒ ะฟัะพะธะทะฒะพะดััะฒะฐ ััะพะณะพ ะฟะพะบะพะปะตะฝะธั (ะฝะฐะฟัะธะผะตั: 2020-2024 ะธะปะธ 2023)",
    "engine": "ะะฒะธะณะฐัะตะปั - ะพะฑัะตะผ ะธ ัะธะฟ (ัะพัะผะฐั: 3.0L Twin-Turbo I6)",
    "power": "ะะพัะฝะพััั ะฒ ะปะพัะฐะดะธะฝัั ัะธะปะฐั (ัะพัะผะฐั: 503 HP)",
    "torque": "ะัััััะธะน ะผะพะผะตะฝั (ัะพัะผะฐั: 650 Nm)",
    "weight": "ะกะฝะฐััะถะตะฝะฝะฐั ะผะฐััะฐ (ัะพัะผะฐั: 1725 kg)",
    "acceleration": "ะะฐะทะณะพะฝ 0-100 ะบะผ/ั (ัะพัะผะฐั: 3.9 s)",
    "top_speed": "ะะฐะบัะธะผะฐะปัะฝะฐั ัะบะพัะพััั (ัะพัะผะฐั: 250 km/h)",
    "country_code": "ะะฒััะฑัะบะฒะตะฝะฝัะน ISO ะบะพะด ัััะฐะฝั ะฟัะพะธะทะฒะพะดะธัะตะปั (DE-ะะตัะผะฐะฝะธั, US-ะกะจะ, JP-ะฏะฟะพะฝะธั, IT-ะัะฐะปะธั, GB-ะะตะปะธะบะพะฑัะธัะฐะฝะธั, FR-ะคัะฐะฝัะธั, KR-ะะพัะตั, SE-ะจะฒะตัะธั, CZ-ะงะตัะธั)"
}}

ะะะะะ: ะัะฟะพะปัะทัะน ัะพะปัะบะพ ะพัะธัะธะฐะปัะฝัะต ะดะฐะฝะฝัะต ะฟัะพะธะทะฒะพะดะธัะตะปั. ะัะปะธ ััะพ ะบะพะฝะบัะตัะฝะฐั ะฒะตััะธั/ะบะพะผะฟะปะตะบัะฐัะธั, ะธัะฟะพะปัะทัะน ะตั ัะฐัะฐะบัะตัะธััะธะบะธ.
"""
        
        try:
            # ะัะฟะพะปัะทัะตะผ ะฑะพะปะตะต ะดะตัะตะฒัั ะผะพะดะตะปั gemini-2.0-flash-exp ะดะปั ะฟะพะธัะบะฐ ัะฐัะฐะบัะตัะธััะธะบ
            response = self.client.models.generate_content(
                model='gemini-2.0-flash-exp',
                contents=prompt
            )
            
            specs_text = response.text.strip()
            # ะัะธััะบะฐ ะพั markdown
            specs_text = specs_text.replace('```json', '').replace('```', '').strip()
            specs = json.loads(specs_text)
            print("โ ะฅะฐัะฐะบัะตัะธััะธะบะธ ะฝะฐะนะดะตะฝั ััะฟะตัะฝะพ")
            print(f"   ะะฒะธะณะฐัะตะปั: {specs.get('engine')}")
            print(f"   ะะพัะฝะพััั: {specs.get('power')}")
            print(f"   ะะฐะทะณะพะฝ: {specs.get('acceleration')}")
            return specs
            
        except Exception as e:
            print(f"โ๏ธ ะัะธะฑะบะฐ ะฟะพะธัะบะฐ ัะฐัะฐะบัะตัะธััะธะบ: {e}")
            print("๐ ะัะฟะพะปัะทัั ะฑะฐะทะพะฒัะต ัะฐัะฐะบัะตัะธััะธะบะธ...")
            return self._get_default_specs(make, model, year)
    
    def _get_default_specs(self, make, model, year):
        """ะะฐะทะพะฒัะต ัะฐัะฐะบัะตัะธััะธะบะธ ะฝะฐ ัะปััะฐะน ะพัะธะฑะบะธ API"""
        return {
            "make": make,
            "model": model,
            "year_range": str(year) if year else "2020-2024",
            "engine": "2.0L Turbo I4",
            "power": "300 HP",
            "torque": "400 Nm",
            "weight": "1500 kg",
            "acceleration": "4.5 s",
            "top_speed": "250 km/h",
            "country_code": "DE"
        }
    
    def get_country_flag_emoji(self, country_code):
        """ะะพะฝะฒะตััะฐัะธั ะบะพะดะฐ ัััะฐะฝั ะฒ ัะปะฐะณ ัะผะพะดะทะธ"""
        if not country_code or len(country_code) != 2:
            return "๐"
        code = country_code.upper()
        flag = ''.join(chr(127397 + ord(char)) for char in code)
        return flag
    
    def generate_poster_prompt(self, specs, color=None):
        """
        ะกะพะทะดะฐะฝะธะต ะฟัะพัะตััะธะพะฝะฐะปัะฝะพะณะพ ะฟัะพะผะฟัะฐ ะดะปั ะณะตะฝะตัะฐัะธะธ ะฟะพััะตัะฐ
        ะัะพะผะฟั ัะฐะทัะฐะฑะพัะฐะฝ ะบะฐะบ prompt engineer ะดะปั ะผะฐะบัะธะผะฐะปัะฝะพะน ัะพัะฝะพััะธ
        """
        
        make = specs['make']
        model = specs['model']
        year = specs['year_range']
        engine = specs['engine']
        power = specs['power']
        torque = specs['torque']
        weight = specs['weight']
        acceleration = specs['acceleration']
        top_speed = specs['top_speed']
        country_code = specs['country_code']
        flag_emoji = self.get_country_flag_emoji(country_code)
        
        color_description = f"ะฒ {color} ัะฒะตัะต" if color else "ะฒ ัะปะตะณะฐะฝัะฝะพะผ ัะตะผะฝะพะผ ัะฒะตัะต"
        
        prompt = f"""
ะะะะะงะ: ะกะพะทะดะฐะน ะฐะฒัะพะผะพะฑะธะปัะฝัะน ะฟะพััะตั ะขะะงะะ ะฟะพ ัะตัะตัะตะฝัะฝะพะผั ะธะทะพะฑัะฐะถะตะฝะธั, ะทะฐะผะตะฝะธะฒ ัะพะปัะบะพ ะฐะฒัะพะผะพะฑะธะปั ะธ ัะตัะฝะธัะตัะบะธะต ะดะฐะฝะฝัะต.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะขะะะะะะะฌ ะะะฏ ะะะกะขะะะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะฐัะบะฐ ะธ ะผะพะดะตะปั: {make} {model}
ะะพะด: {year}
ะฆะฒะตั: {color_description}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะะะะฆะะฏ ะ ะกะขะะฃะะขะฃะะ (ะกะขะะะะ ะะะ ะะ ะะะคะะะะะกะ):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะคะะะะะข:
โข ะะตััะธะบะฐะปัะฝัะน ะฟะพััะตั, ัะพะพัะฝะพัะตะฝะธะต ััะพัะพะฝ ะฟัะธะผะตัะฝะพ 3:4
โข ะะธะฝะธะผะฐะปะธััะธัะฝัะน, ะฟัะพัะตััะธะพะฝะฐะปัะฝัะน ะดะธะทะฐะนะฝ
โข ะกะฒะตัะปัะน ะฝะตะนััะฐะปัะฝัะน ัะพะฝ (#F5F5F5 ะธะปะธ ะฟะพะดะพะฑะฝัะน)

ะะะะฅะะฏะฏ ะงะะกะขะฌ (ะขะะะกะขะะะซะ ะะะะ):
โข ะะฐัะบะฐ ะฐะฒัะพะผะพะฑะธะปั: "{make.upper()}" - ะบััะฟะฝัะน ะถะธัะฝัะน ััะธัั, ัะตะผะฝะพ-ัะตััะน ัะฒะตั (#333333)
โข ะะพะดะตะปั ะฐะฒัะพะผะพะฑะธะปั: "{model.upper()}" - ะพัะตะฝั ะบััะฟะฝัะน ะถะธัะฝัะน ััะธัั, ัะตัะฝัะน ัะฒะตั (#000000)
โข ะะฐัะฟะพะปะพะถะตะฝะธะต: ะปะตะฒัะน ะฒะตััะฝะธะน ัะณะพะป ะฟะพััะตัะฐ, ั ะพััััะฟะพะผ ะพั ะบัะฐั

ะฆะะะขะะะะฌะะะฏ ะงะะกะขะฌ (ะะะะะะะะะะะ ะะะขะะะะะะะฏ):
โข ะัะพัะตััะธะพะฝะฐะปัะฝะฐั ัะพัะพะณัะฐัะธั {make} {model} {color_description}
โข ะะฐะบััั: ััะธ ัะตัะฒะตััะธ ัะฟะตัะตะดะธ (front 3/4 view)
โข ะัะฒะตัะตะฝะธะต: ัััะดะธะนะฝะพะต, ะผัะณะบะพะต, ัะฐะฒะฝะพะผะตัะฝะพะต
โข ะคะพะฝ ะทะฐ ะฐะฒัะพะผะพะฑะธะปะตะผ: ัะธัััะน ะฑะตะปัะน ะธะปะธ ัะฒะตัะปะพ-ัะตััะน ะณัะฐะดะธะตะฝั
โข ะกัะธะปั: ะบะฐะบ ะฒ ะฐะฒัะพะผะพะฑะธะปัะฝะพะผ ัะพั-ััะผะต ะธะปะธ ะผะฐัะบะตัะธะฝะณะพะฒัั ะผะฐัะตัะธะฐะปะฐั ะฟัะตะผะธัะผ-ะบะปะฐััะฐ
โข ะะฒัะพะผะพะฑะธะปั ะทะฐะฝะธะผะฐะตั ัะตะฝััะฐะปัะฝัั ัะฐััั ะฟะพััะตัะฐ
โข ะขะตะฝะธ: ัะพะฝะบะธะต, ัะตะฐะปะธััะธัะฝัะต ะฟะพะด ะฐะฒัะพะผะพะฑะธะปะตะผ
โข ะะฐัะตััะฒะพ: ัะพัะพัะตะฐะปะธััะธัะฝะพะต, ะฒััะพะบะพะต ัะฐะทัะตัะตะฝะธะต

ะะะะะฏะฏ ะงะะกะขะฌ (ะขะะฅะะะงะะกะะะ ะฅะะะะะขะะะะกะขะะะ):
ะะฐัะฟะพะปะพะถะธ ัะฐัะฐะบัะตัะธััะธะบะธ ะฒ ะฒะธะดะต ะพัะณะฐะฝะธะทะพะฒะฐะฝะฝะพะน ัะตัะบะธ ะฟะพะด ะธะทะพะฑัะฐะถะตะฝะธะตะผ ะฐะฒัะพะผะพะฑะธะปั:

ะะะะะฏ ะะะะะะะ:
โข "YEAR" (ะทะฐะณะพะปะพะฒะพะบ) - ะถะธัะฝัะผ
โข "{year}" (ะทะฝะฐัะตะฝะธะต) - ะฟะพะด ะทะฐะณะพะปะพะฒะบะพะผ

ะกะะะะะฏะฏ ะะะะะะะ (ัะฐัะฐะบัะตัะธััะธะบะธ ะฒ ััะพะปะฑะธะบ):
โข "Engine" (ัะตััะน ัะตะบัั) โ "{engine}" (ัะตัะฝัะน ัะตะบัั)
โข "Power" (ัะตััะน ัะตะบัั) โ "{power}" (ัะตัะฝัะน ัะตะบัั)
โข "Torque" (ัะตััะน ัะตะบัั) โ "{torque}" (ัะตัะฝัะน ัะตะบัั)
โข "Weight" (ัะตััะน ัะตะบัั) โ "{weight}" (ัะตัะฝัะน ัะตะบัั)

ะะะะะะฏ ะะะะะะะ:
โข "0-100 km/h" (ัะตััะน ัะตะบัั) โ "{acceleration}" (ัะตัะฝัะน ัะตะบัั)
โข "Top speed" (ัะตััะน ัะตะบัั) โ "{top_speed}" (ัะตัะฝัะน ัะตะบัั)

ะคะะะ ะกะขะะะะซ:
โข ะ ะฟัะฐะฒะพะผ ะฝะธะถะฝะตะผ ัะณะปั ะฟะพััะตัะฐ: ัะปะฐะณ {flag_emoji} (ัััะฐะฝะฐ: {country_code})

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะขะะงะะกะะะ ะขะะะะะะะะะฏ ะ ะกะขะะะฎ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะขะะะะะะะคะะะ:
โ ะัะฟะพะปัะทัะน ัะพะฒัะตะผะตะฝะฝัะต sans-serif ััะธััั (ะบะฐะบ Helvetica, Arial, ะธะปะธ ะฟะพะดะพะฑะฝัะต)
โ ะงะตัะบะฐั ะธะตัะฐััะธั ัะฐะทะผะตัะพะฒ: ะผะฐัะบะฐ (ะฑะพะปััะพะน) โ ะผะพะดะตะปั (ะพัะตะฝั ะฑะพะปััะพะน) โ ัะฐัะฐะบัะตัะธััะธะบะธ (ััะตะดะฝะธะน)
โ ะะดะตะฐะปัะฝะพะต ะฒััะฐะฒะฝะธะฒะฐะฝะธะต ะธ ะธะฝัะตัะฒะฐะปั ะผะตะถะดั ัะปะตะผะตะฝัะฐะผะธ
โ ะะกะ ะฆะะคะะซ ะ ะขะะะกะข ะะะะะะซ ะะซะขะฌ ะะะกะะะฎะขะะ ะขะะงะะซะะ - ะฑะตะท ะพัะธะฑะพะบ ะธ ะพะฟะตัะฐัะพะบ

ะฆะะะขะะะะฏ ะกะฅะะะ:
โ ะคะพะฝ: ัะฒะตัะปัะน ะฝะตะนััะฐะปัะฝัะน (#F5F5F5)
โ ะะฐะณะพะปะพะฒะบะธ ะผะฐัะบะธ/ะผะพะดะตะปะธ: ัะตะผะฝะพ-ัะตััะน ะธ ัะตัะฝัะน
โ ะะตะนะฑะปั ัะฐัะฐะบัะตัะธััะธะบ: ััะตะดะฝะต-ัะตััะน (#666666)
โ ะะฝะฐัะตะฝะธั ัะฐัะฐะบัะตัะธััะธะบ: ัะตัะฝัะน (#000000)
โ ะะฑัะธะน ััะธะปั: ะผะธะฝะธะผะฐะปะธััะธัะฝัะน, ะฟัะตะผะธัะผ, ะฟัะพัะตััะธะพะฝะฐะปัะฝัะน

ะะะะะะะะะะะ ะะะขะะะะะะะฏ:
โ {make} {model} {year} {color_description}
โ ะคะพัะพัะตะฐะปะธััะธัะฝะพะต ะบะฐัะตััะฒะพ
โ ะกััะดะธะนะฝะพะต ะพัะฒะตัะตะฝะธะต, ะฑะตะท ัะตะทะบะธั ัะตะฝะตะน
โ ะะฐะบััั: ะฟะตัะตะดะฝะธะต ััะธ ัะตัะฒะตััะธ (ะฟะพะบะฐะทัะฒะฐะตั ะฟะตัะตะดะฝัั ัะฐััั ะธ ัะฑะพะบั)
โ ะะฒัะพะผะพะฑะธะปั ัะตัะบะพ ะฒ ัะพะบััะต
โ ะงะธัััะน ัะพะฝ ะฑะตะท ะพัะฒะปะตะบะฐััะธั ัะปะตะผะตะฝัะพะฒ
โ ะะฐะบ ะฒ ะพัะธัะธะฐะปัะฝัั ะฟัะตัั-ัะพัะพ ะฟัะพะธะทะฒะพะดะธัะตะปั

ะขะะงะะะกะขะฌ ะะะะะซะฅ:
โ ะะฐัะบะฐ: {make.upper()}
โ ะะพะดะตะปั: {model.upper()}
โ ะะพะด: {year}
โ ะะฒะธะณะฐัะตะปั: {engine}
โ ะะพัะฝะพััั: {power}
โ ะะพะผะตะฝั: {torque}
โ ะะฐััะฐ: {weight}
โ 0-100: {acceleration}
โ ะะฐะบั.ัะบะพัะพััั: {top_speed}
โ ะคะปะฐะณ: {flag_emoji}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะะฉะะะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะัะฑัะต ะปะพะณะพัะธะฟั ะธะปะธ ะฒะพะดัะฝัะต ะทะฝะฐะบะธ
โ ะะพะฟะพะปะฝะธัะตะปัะฝัะน ัะตะบัั, ะฝะต ัะบะฐะทะฐะฝะฝัะน ะฒััะต
โ ะะฐะทะผัััะต ะธะปะธ ะฝะตัะตัะบะธะต ะธะทะพะฑัะฐะถะตะฝะธั
โ ะะตะฟัะฐะฒะธะปัะฝัะต ะธะปะธ ะฒัะดัะผะฐะฝะฝัะต ัะฐัะฐะบัะตัะธััะธะบะธ
โ ะะฟะตัะฐัะบะธ ะฒ ัะตะบััะต ะธะปะธ ัะธััะฐั
โ ะัะบะฐะถะตะฝะฝัะต ะฟัะพะฟะพััะธะธ ะฐะฒัะพะผะพะฑะธะปั
โ ะัะบะปะพะฝะตะฝะธั ะพั ัะตัะตัะตะฝัะฝะพะน ะบะพะผะฟะพะทะธัะธะธ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะคะะะะะฌะะซะ ะะะะฃะะฌะขะะข:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะัะพัะตััะธะพะฝะฐะปัะฝัะน ะฐะฒัะพะผะพะฑะธะปัะฝัะน ะฟะพััะตั ะฒ ััะธะปะต ะฟัะตะผะธัะผ-ะผะฐัะบะตัะธะฝะณะฐ,
ะบะพัะพััะน ะผะพะณ ะฑั ะธัะฟะพะปัะทะพะฒะฐัััั ะดะธะปะตัะพะผ ะธะปะธ ะฟัะพะธะทะฒะพะดะธัะตะปะตะผ ะฐะฒัะพะผะพะฑะธะปะตะน.
ะงะธัััะน, ัะปะตะณะฐะฝัะฝัะน, ะธะฝัะพัะผะฐัะธะฒะฝัะน ะดะธะทะฐะนะฝ ั ัะพะบััะพะผ ะฝะฐ ะฐะฒัะพะผะพะฑะธะปั ะธ
ัะพัะฝัะต ัะตัะฝะธัะตัะบะธะต ะดะฐะฝะฝัะต.

ะกะขะะะะ ะกะะะะฃะ ะะะะะะะะฆะะ ะะะคะะะะะกะะะะ ะะะะะะะะะะะฏ!
"""
        
        return prompt
    
    def generate_poster(self, make, model, year=None, trim=None, color=None, output_path=None):
        """ะะตะฝะตัะฐัะธั ะฟะพะปะฝะพะณะพ ะฟะพััะตัะฐ ัะตัะตะท Gemini AI"""
        
        print(f"\n{'='*70}")
        print(f"๐ ะะะะะะะฆะะฏ ะะะกะขะะะ: {make} {model}")
        print(f"{'='*70}\n")
        
        # ะจะฐะณ 1: ะะพะปััะธัั ัะฐัะฐะบัะตัะธััะธะบะธ ะฐะฒัะพะผะพะฑะธะปั
        specs = self.search_car_specifications(make, model, year, trim)
        
        # ะจะฐะณ 2: ะกะพะทะดะฐัั ะฟัะพะผะฟั ะดะปั ะณะตะฝะตัะฐัะธะธ ะฟะพััะตัะฐ
        print("\n๐ ะกะพะทะดะฐะฝะธะต ะฟัะพะผะฟัะฐ ะดะปั AI-ะณะตะฝะตัะฐัะธะธ...")
        prompt = self.generate_poster_prompt(specs, color)
        
        # ะจะฐะณ 3: ะะตะฝะตัะฐัะธั ะฟะพััะตัะฐ ัะตัะตะท Gemini 3 Pro Image Preview (Nano Banana Pro)
        print("\n๐จ ะะตะฝะตัะฐัะธั ะฟะพััะตัะฐ ัะตัะตะท Gemini 3 Pro Image (Nano Banana Pro)...")
        print("โณ ะญัะพ ะผะพะถะตั ะทะฐะฝััั 10-30 ัะตะบัะฝะด...")
        
        try:
            # ะัะฟะพะปัะทัะตะผ gemini-3-pro-image-preview ะดะปั ะณะตะฝะตัะฐัะธะธ ะธะทะพะฑัะฐะถะตะฝะธั
            response = self.client.models.generate_content(
                model='gemini-3-pro-image-preview',
                contents=[prompt, self.reference_image],
                config=types.GenerateContentConfig(
                    response_modalities=['TEXT', 'IMAGE'],
                    temperature=0.3,
                )
            )
            
            print("๐ฅ ะะพะปััะตะฝ ะพัะฒะตั ะพั Gemini API...")
            
            # ะะทะฒะปะตะบะฐะตะผ ัะณะตะฝะตัะธัะพะฒะฐะฝะฝะพะต ะธะทะพะฑัะฐะถะตะฝะธะต
            poster_image = None
            for part in response.parts:
                if part.text is not None:
                    print(f"๐ ะะพะผะผะตะฝัะฐัะธะน AI: {part.text[:200]}...")
                elif part.inline_data is not None:
                    poster_image = part.as_image()
                    print("โ ะะพััะตั ััะฟะตัะฝะพ ัะณะตะฝะตัะธัะพะฒะฐะฝ!")
                    break
            
            if poster_image is None:
                raise ValueError("ะะต ัะดะฐะปะพัั ะธะทะฒะปะตัั ะธะทะพะฑัะฐะถะตะฝะธะต ะธะท ะพัะฒะตัะฐ API")
            
            # ะจะฐะณ 4: ะกะพััะฐะฝะตะฝะธะต ะฟะพััะตัะฐ
            if not output_path:
                output_dir = Path(self.output_directory)
                output_dir.mkdir(exist_ok=True)
                filename = f"{make}_{model}_{year or specs['year_range']}.{self.output_format}"
                output_path = output_dir / filename
            
            # ะกะพััะฐะฝะตะฝะธะต ะฒ ะฝัะถะฝะพะผ ัะพัะผะฐัะต
            if self.output_format == 'jpg':
                poster_image = poster_image.convert('RGB')
                poster_image.save(output_path, 'JPEG', quality=95, optimize=True)
            else:
                poster_image.save(output_path, 'PNG', optimize=True)
            
            print(f"\nโ ะะะกะขะะ ะกะะฅะะะะะ: {output_path}")
            print(f"{'='*70}\n")
            
            return str(output_path)
            
        except Exception as e:
            print(f"\nโ ะะจะะะะ ะะะะะะะฆะะ: {e}")
            print(f"ะขะธะฟ ะพัะธะฑะบะธ: {type(e).__name__}")
            raise
    
    # ะะปะธะฐั ะดะปั ะพะฑัะฐัะฝะพะน ัะพะฒะผะตััะธะผะพััะธ
    create_poster = generate_poster


def main():
    """ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั"""
    
    print("๐ Car Poster Generator - AI Edition")
    print("ะะพะปะฝะฐั ะณะตะฝะตัะฐัะธั ะฟะพััะตัะฐ ัะตัะตะท Gemini 3 Pro Image (Nano Banana Pro)\n")
    
    # ะกะพะทะดะฐะตะผ ะณะตะฝะตัะฐัะพั (ะฝะฐัััะพะนะบะธ ะธะท .env)
    generator = CarPosterGenerator()
    
    # ะัะธะผะตัั ะฐะฒัะพะผะพะฑะธะปะตะน
    examples = [
        {
            "make": "BMW",
            "model": "M4 Competition",
            "year": 2023,
            "color": "Alpine White"
        },
        {
            "make": "Porsche",
            "model": "911 GT3",
            "year": 2024,
            "trim": "RS",
            "color": "Racing Yellow"
        },
        {
            "make": "Mercedes-AMG",
            "model": "GT R",
            "year": 2022,
            "color": "AMG Green Hell Magno"
        },
        {
            "make": "Audi",
            "model": "RS6 Avant",
            "year": 2023,
            "color": "Nardo Grey"
        }
    ]
    
    # ะะตะฝะตัะธััะตะผ ะฟะตัะฒัะน ะฟัะธะผะตั
    result = generator.generate_poster(**examples[0])
    print(f"\n๐ ะะพัะพะฒะพ! ะคะฐะนะป: {result}")


if __name__ == "__main__":
    main()